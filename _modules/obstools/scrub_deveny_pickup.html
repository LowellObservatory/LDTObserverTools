<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>obstools.scrub_deveny_pickup &mdash; LDT Observer Tools 2025 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=beddf052" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=a0fb6060" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=cb975c41"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/obstools_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.7.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">LMI Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../lmi_etc.html">Exposure Time Calculator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lmi_ql.html">LMI Quick Look Tool</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DeVeny Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../deveny_grangle.html">Grating Angle Calculator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deveny_collfocus.html">Collimator Focus Sequence Estimator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dfocus.html">Collimator Focus Calculator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deveny_etc.html">Exposure Time Calculator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scrub_deveny_pickup.html">Pickup Noise Scrubber</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deveny_ql.html">DeVeny Spectrum Quick Look Tool</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RIMAS Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../rimas_etc.html">Exposure Time Calculator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rimas_image_ql.html">RIMAS Imaging Quick Look Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rimas_spec_ql.html">RIMAS Spectrum Quick Look Tool</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">General LDT Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fix_ldt_header.html">Simple FITS Header Fixer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../neocp_ephem.html">NEO CP Ephemeris Generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input_validator.html">Input List Validator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../observer_target.html">Observer Target List Tool</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">For developers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">LDTObserverTools API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">LDT Observer Tools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../obstools.html">obstools</a></li>
      <li class="breadcrumb-item active">obstools.scrub_deveny_pickup</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for obstools.scrub_deveny_pickup</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1">#  This Source Code Form is subject to the terms of the Mozilla Public</span>
<span class="c1">#  License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<span class="c1">#  file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<span class="c1">#</span>
<span class="c1">#  Created on 05-Dec-2022</span>
<span class="c1">#  Modified: 15-Sep-2023</span>
<span class="c1">#</span>
<span class="c1">#  @author: tbowers</span>

<span class="sd">&quot;&quot;&quot;Scrubber for DeVeny Pickup Noise Module</span>

<span class="sd">LDTObserverTools contains python ports of various LDT Observer Tools</span>

<span class="sd">Lowell Discovery Telescope (Lowell Observatory: Flagstaff, AZ)</span>
<span class="sd">https://lowell.edu</span>

<span class="sd">This module cleans the RF pickup noise from DeVeny spectral 2D images by</span>
<span class="sd">fitting a sinusoid to and then subtracting it from each row of the image.</span>

<span class="sd">The frequency of the sinusoid tends to vary from frame to frame but is roughly</span>
<span class="sd">CONSTANT within each frame.  Between the non-integer wavelength and the slight</span>
<span class="sd">delay between row read-out (caused by the advancement of the parallel register)</span>
<span class="sd">the phase shifts from row to row, yielding an ever-changing pattern in the</span>
<span class="sd">output images.  In order to identify the frequency in a given image, this</span>
<span class="sd">module fist taken the FFT of the flattened (`i.e.`, `time series`) image to</span>
<span class="sd">identify the strongest frequency.  (The function that performs the FFT also</span>
<span class="sd">modifies a copy of the data in various ways to remove spurious signals in the</span>
<span class="sd">FFT.)  From there, it uses a tightly bounded curve fitting (from</span>
<span class="sd">:obj:`scipy.optimize`) to identify the sinusoid in each line of the image.</span>

<span class="sd">Cosmic rays and other impulsive features in the 2D image can cause spurious</span>
<span class="sd">matches for the sinusoid.  So to guard against introducing artifacts into the</span>
<span class="sd">cleaned image from the fitting, the row-by-row fit coefficients are each</span>
<span class="sd">considered as a function and smoothed with an appropriate median window to</span>
<span class="sd">ensure the final subtracted pattern is a smooth function, matching the</span>
<span class="sd">underlying pickup noise.</span>

<span class="sd">The output of the module is a multi-extension FITS file containing [1] the</span>
<span class="sd">cleaned image, [2] the original image, [3,4] the pattern subtracted from the</span>
<span class="sd">original image, and [5] a FITS BinTable containing the sinusoid fit parameters</span>
<span class="sd">for each row of the image.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Built-In Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="c1"># 3rd Party Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.io.fits</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.nddata</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.table</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.visualization</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.wcs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ccdproc.utils.slices</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pypeit</span><span class="w"> </span><span class="kn">import</span> <span class="n">msgs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pypeit.spec2dobj</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.fft</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.ndimage</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.optimize</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.signal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># Internal Imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">obstools</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span>

<span class="c1"># Mean pixel readout time (7.25 µs)</span>
<span class="n">PIX_DWELL</span> <span class="o">=</span> <span class="mf">7.25e-6</span>

<span class="c1"># Silence a couple known-but-don&#39;t-care-about warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">FITSFixedWarning</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">verify</span><span class="o">.</span><span class="n">VerifyWarning</span><span class="p">)</span>


<span class="c1"># Narrative Functions ========================================================#</span>
<div class="viewcode-block" id="iterative_pypeit_clean">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.iterative_pypeit_clean">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">iterative_pypeit_clean</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
    <span class="n">proc_dir</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite_raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">diagnostics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">no_refit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">extra_graphics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">rerun_fft</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iteratively use PypeIt to clean pickup noise</span>

<span class="sd">    As part of the data-reduction process, PypeIt fits and extracts images as</span>
<span class="sd">    well as the sky background.  We can use the reduced ``spec2d`` files to</span>
<span class="sd">    get the &quot;source-free&quot; noise background, which makes identifying the</span>
<span class="sd">    sinusoidal noise more straightforward.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : :obj:`~pathlib.Path`</span>
<span class="sd">        The name of the file to clean</span>
<span class="sd">    proc_dir : :obj:`~pathlib.Path`, optional</span>
<span class="sd">        The location of the PypeIt-processed images, if not ``./ldt_deveny_?/``</span>
<span class="sd">        (Default: None)</span>
<span class="sd">    overwrite_raw : :obj:`bool`, optional</span>
<span class="sd">        Overwrite the raw file rather than create a new file with the &#39;_scrub&#39;</span>
<span class="sd">        suffix  (Default: False)</span>
<span class="sd">    diagnostics : :obj:`bool`, optional</span>
<span class="sd">        Output additional information and plots during the image analysis?</span>
<span class="sd">        (Default: False)</span>
<span class="sd">    no_refit : :obj:`bool`, optional</span>
<span class="sd">        Do not refit lines with &quot;bad&quot; RMS  (Default: False)</span>
<span class="sd">    extra_graphics : :obj:`bool`, optional</span>
<span class="sd">        Produce extra graphics formats for documentation?  (Default: False)</span>
<span class="sd">    rereun_fft : :obj:`bool`, optional</span>
<span class="sd">        Pass the fitted pattern through the FFT analysis?  (Default: False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Print a welcome statement</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing frame </span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Find the corresponding `spec2d` file for this raw file -- the list</span>
    <span class="c1">#   comprehension searches in each possible &#39;instrument setup&#39; directory</span>
    <span class="c1">#   Check that the `spec2d` file actually exists and print a helpful</span>
    <span class="c1">#   message if it doesn&#39;t.</span>
    <span class="n">pyp_dir</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">proc_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;ldt_deveny_?&quot;</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Look for the spec2d file</span>
        <span class="n">spec2d_file</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">flatten_comprehension</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;Science&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spec2d_</span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">-*.fits&quot;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">pyp_dir</span>
            <span class="p">]</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">StopIteration</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
        <span class="c1"># And... fail.</span>
        <span class="n">msgs</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not have a corresponding PypeIt-processed 2D spectrum. &quot;</span>
            <span class="s2">&quot;Check the image type and whether you have `run_pypeit`.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># Define (and create, if needed) the QA directory for these plots</span>
    <span class="n">qa_dir</span> <span class="o">=</span> <span class="n">spec2d_file</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;QA&quot;</span> <span class="o">/</span> <span class="s2">&quot;PDFs&quot;</span>
    <span class="n">qa_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Load in the PypeIt-produced `spec2d`` file and produce the residual image</span>
    <span class="c1">#   Also rotate all images -90º to align with the raw DeVeny frames</span>
    <span class="n">spec2d</span> <span class="o">=</span> <span class="n">pypeit</span><span class="o">.</span><span class="n">spec2dobj</span><span class="o">.</span><span class="n">Spec2DObj</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">spec2d_file</span><span class="p">,</span> <span class="s2">&quot;DET01&quot;</span><span class="p">)</span>
    <span class="n">resid_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
        <span class="p">(</span><span class="n">spec2d</span><span class="o">.</span><span class="n">sciimg</span> <span class="o">-</span> <span class="n">spec2d</span><span class="o">.</span><span class="n">skymodel</span> <span class="o">-</span> <span class="n">spec2d</span><span class="o">.</span><span class="n">objmodel</span><span class="p">)</span>  <span class="c1"># Residual Image</span>
        <span class="o">*</span> <span class="n">spec2d</span><span class="o">.</span><span class="n">select_flag</span><span class="p">(</span><span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>  <span class="c1"># Good Pixel Mask</span>
        <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Rotate CCW</span>
    <span class="p">)</span>

    <span class="c1"># Bright objects can mess with the FFT cleaning as well as other parts</span>
    <span class="c1">#   of this process.</span>
    <span class="n">objmodel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">spec2d</span><span class="o">.</span><span class="n">objmodel</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># To guide the fitting of sinusoids to individual lines, compute the</span>
    <span class="c1">#   expected (average) pixel period from the FFT of the flattened array.</span>
    <span class="n">resid_pixperiod</span> <span class="o">=</span> <span class="n">flatten_clean_fft</span><span class="p">(</span>
        <span class="n">resid_img</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">fft_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">qa_dir</span><span class="o">=</span><span class="n">qa_dir</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="n">extra_graphics</span><span class="o">=</span><span class="n">extra_graphics</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   --&gt; FFT-predicted pixel period: </span><span class="si">{</span><span class="n">resid_pixperiod</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pix&quot;</span><span class="p">)</span>

    <span class="c1"># First, if the brightest part of the object model is &gt; 600, then the</span>
    <span class="c1">#   sinusoidal signal only imparts a 1% effect.  Skip objmodel checking</span>
    <span class="c1">#   for these cases</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">objmodel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">600</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; * Object model &gt; 100x sinusoidal signal.  Moving along...&quot;</span><span class="p">)</span>
        <span class="n">with_obj</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">objmodel</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; * No object model extracted.  Moving along...&quot;</span><span class="p">)</span>
        <span class="n">with_obj</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Before fitting the image, inspect the objmodel for sinusoidal signal of the</span>
    <span class="c1">#  type we&#39;re looking for</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking the object model for bulk sinusoidal signal...&quot;</span><span class="p">)</span>
        <span class="n">obj_fitc</span> <span class="o">=</span> <span class="n">fit_lines</span><span class="p">(</span>
            <span class="n">objmodel</span><span class="p">,</span>
            <span class="n">resid_pixperiod</span><span class="p">,</span>
            <span class="n">trim_ends</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">objmodel_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">show_diagnostic</span><span class="o">=</span><span class="n">diagnostics</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># TODO: Tweak this and add protections against bright objects</span>

        <span class="c1"># This will be a tunable parameter</span>
        <span class="k">if</span> <span class="n">obj_fitc</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">obj_fitc</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Add the object model back into the residual image because we need to</span>
            <span class="c1">#   fit out the sine from the object.</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot; * Adding the object model back into the residual image for &quot;</span>
                <span class="s2">&quot;fitting; extracted object contains target sinusoidal signal, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;amplitude = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">obj_fitc</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="n">resid_img</span> <span class="o">+=</span> <span class="n">objmodel</span>
            <span class="n">with_obj</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; * Object model appears clean of target sinusoidal signal.&quot;</span><span class="p">)</span>
            <span class="n">with_obj</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Fit a sinusoid to each line in the image using the pixel period as a guess</span>
    <span class="c1">#  ==&gt; This is the main point of the function</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fitting sinusoids to each line in the image...&quot;</span><span class="p">)</span>
    <span class="n">resid_fitc</span> <span class="o">=</span> <span class="n">fit_lines</span><span class="p">(</span>
        <span class="n">resid_img</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">resid_pixperiod</span><span class="p">,</span> <span class="n">trim_ends</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_diagnostic</span><span class="o">=</span><span class="n">diagnostics</span>
    <span class="p">)</span>
    <span class="c1"># Print a happy statement of fact</span>
    <span class="n">mean_fit_period</span> <span class="o">=</span> <span class="n">resid_fitc</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   --&gt; Mean fit pixel period: </span><span class="si">{</span><span class="n">mean_fit_period</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pix&quot;</span><span class="p">)</span>

    <span class="c1"># Refit lines by passing the existing fit coeffs to fit_lines()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_refit</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refitting lines with poor fit in first pass...&quot;</span><span class="p">)</span>
        <span class="n">resid_fitc</span> <span class="o">=</span> <span class="n">fit_lines</span><span class="p">(</span>
            <span class="n">resid_img</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">resid_pixperiod</span><span class="p">,</span>
            <span class="n">orig_fitc</span><span class="o">=</span><span class="n">resid_fitc</span><span class="p">,</span>
            <span class="n">trim_ends</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">show_diagnostic</span><span class="o">=</span><span class="n">diagnostics</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># (Re-)Print a happy statement of fact</span>
        <span class="n">mean_fit_period</span> <span class="o">=</span> <span class="n">resid_fitc</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   --&gt; Mean fit pixel period: </span><span class="si">{</span><span class="n">mean_fit_period</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pix&quot;</span><span class="p">)</span>

        <span class="c1"># This last step refits the residual image using the knowledge that the</span>
        <span class="c1">#   AC pickup noise is of nearly constant amplitude and period.  The</span>
        <span class="c1">#   `fixed_sinusoid` argument to fit_lines() fits an order=2 polynomial</span>
        <span class="c1">#   to each of the amplitude and period as a function of row number,</span>
        <span class="c1">#   and then fixes those values in the sinusoid fit of each row to the</span>
        <span class="c1">#   smoothed value.  This has the effect of the sinusoid fitting only</span>
        <span class="c1">#   considering the sinusoid phase and underlying order=2 polynomial of</span>
        <span class="c1">#   the row.  This is designed to REDUCE noise by eliminating the</span>
        <span class="c1">#   random oscillations in these parameters due to fitting a sinusoid</span>
        <span class="c1">#   to noisy data.</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Refitting all lines within the slit assuming nearly constant sinusoid...&quot;</span>
        <span class="p">)</span>
        <span class="n">fixed_fitc</span><span class="p">,</span> <span class="n">smoothing</span> <span class="o">=</span> <span class="n">fit_lines</span><span class="p">(</span>
            <span class="n">resid_img</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">resid_pixperiod</span><span class="p">,</span>
            <span class="n">orig_fitc</span><span class="o">=</span><span class="n">resid_fitc</span><span class="p">,</span>
            <span class="n">trim_ends</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">show_diagnostic</span><span class="o">=</span><span class="n">diagnostics</span><span class="p">,</span>
            <span class="n">fixed_sinusoid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># (Re-re-)Print a happy statement of fact</span>
        <span class="n">mean_fit_period</span> <span class="o">=</span> <span class="n">fixed_fitc</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   --&gt; Mean fit pixel period: </span><span class="si">{</span><span class="n">mean_fit_period</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pix&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fixed_fitc</span><span class="p">,</span> <span class="n">smoothing</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># Construct the pattern image and apply it to the input (pattern has mean = 0)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">pattern_resid</span> <span class="o">=</span> <span class="n">create_and_apply_pattern</span><span class="p">(</span>
        <span class="n">resid_img</span><span class="p">,</span> <span class="n">resid_fitc</span> <span class="k">if</span> <span class="n">no_refit</span> <span class="k">else</span> <span class="n">fixed_fitc</span>
    <span class="p">)</span>

    <span class="c1"># Make disgnostic plots</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Writing QA plots to </span><span class="si">{</span><span class="n">qa_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">make_image_comparison_plots</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span>
        <span class="n">spec2d</span><span class="p">,</span>
        <span class="n">resid_img</span><span class="p">,</span>
        <span class="n">pattern_resid</span><span class="p">,</span>
        <span class="n">qa_dir</span><span class="o">=</span><span class="n">qa_dir</span><span class="p">,</span>
        <span class="n">with_obj</span><span class="o">=</span><span class="n">with_obj</span><span class="p">,</span>
        <span class="n">extra_graphics</span><span class="o">=</span><span class="n">extra_graphics</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">make_sinusoid_fit_plots</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span>
        <span class="n">resid_fitc</span><span class="p">,</span>
        <span class="n">resid_pixperiod</span><span class="p">,</span>
        <span class="n">qa_dir</span><span class="o">=</span><span class="n">qa_dir</span><span class="p">,</span>
        <span class="n">extra_graphics</span><span class="o">=</span><span class="n">extra_graphics</span><span class="p">,</span>
        <span class="n">fixed_fitc</span><span class="o">=</span><span class="n">fixed_fitc</span><span class="p">,</span>
        <span class="n">smoothing</span><span class="o">=</span><span class="n">smoothing</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># If desired, run the pattern back though the FFT function for comparison</span>
    <span class="k">if</span> <span class="n">rerun_fft</span><span class="p">:</span>
        <span class="n">pattern_pixperiod</span> <span class="o">=</span> <span class="n">flatten_clean_fft</span><span class="p">(</span>
            <span class="n">pattern_resid</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">fft_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">qa_dir</span><span class="o">=</span><span class="n">qa_dir</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="o">.</span><span class="n">with_stem</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_pattern&quot;</span><span class="p">),</span>
            <span class="n">extra_graphics</span><span class="o">=</span><span class="n">extra_graphics</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   --&gt; FFT-predicted pixel period: </span><span class="si">{</span><span class="n">pattern_pixperiod</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pix&quot;</span><span class="p">)</span>

        <span class="n">cleaned_pixperiod</span> <span class="o">=</span> <span class="n">flatten_clean_fft</span><span class="p">(</span>
            <span class="n">resid_img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">-</span> <span class="n">pattern_resid</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">fft_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">qa_dir</span><span class="o">=</span><span class="n">qa_dir</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="o">.</span><span class="n">with_stem</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_cleaned&quot;</span><span class="p">),</span>
            <span class="n">extra_graphics</span><span class="o">=</span><span class="n">extra_graphics</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   --&gt; FFT-predicted pixel period: </span><span class="si">{</span><span class="n">cleaned_pixperiod</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pix&quot;</span><span class="p">)</span>

    <span class="c1"># Next, use the pattern to clean the raw image and repackage</span>
    <span class="c1"># Load in the raw dataframe</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">nddata</span><span class="o">.</span><span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Since the above work was done on PypeIt-reduced frames, we need to place</span>
    <span class="c1">#   those products within the larger (untrimmed) raw frame.</span>
    <span class="n">trimsec</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">slices</span><span class="o">.</span><span class="n">slice_from_string</span><span class="p">(</span>
        <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;TRIMSEC&quot;</span><span class="p">],</span> <span class="n">fits_convention</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># NOTE: The PypeIt-processed data are in e-, whereas the raw data are in ADU</span>
    <span class="n">pattern_resid</span> <span class="o">/=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;GAIN&quot;</span><span class="p">]</span>

    <span class="c1"># Make the cleaned array &amp; the pattern array -- all in ADU</span>
    <span class="n">cleaned_array</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">cleaned_array</span><span class="p">[</span><span class="n">trimsec</span><span class="p">]</span> <span class="o">-=</span> <span class="n">pattern_resid</span>

    <span class="n">pattern_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">pattern_array</span><span class="p">[</span><span class="n">trimsec</span><span class="p">]</span> <span class="o">=</span> <span class="n">pattern_resid</span>

    <span class="c1"># Package it up into a processed FITS image</span>
    <span class="n">package_into_fits</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span>
        <span class="n">ccd</span><span class="p">,</span>
        <span class="n">cleaned_array</span><span class="p">,</span>
        <span class="n">pattern_array</span><span class="p">,</span>
        <span class="n">resid_fitc</span> <span class="k">if</span> <span class="n">no_refit</span> <span class="k">else</span> <span class="n">fixed_fitc</span><span class="p">,</span>
        <span class="n">resid_pixperiod</span><span class="p">,</span>
        <span class="n">overwrite_raw</span><span class="o">=</span><span class="n">overwrite_raw</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="clean_pickup">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.clean_pickup">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_pickup</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
    <span class="n">use_hann</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sine_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">fft_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean the Pickup Noise</span>

<span class="sd">    .. warning::</span>

<span class="sd">        Deprecated -- do not use.  Only included for historical purposes.</span>
<span class="sd">        Use :func:`iterative_pypeit_clean` instead.</span>

<span class="sd">    This is the first version of the cleaning code, which operates directly on</span>
<span class="sd">    the raw DeVeny image.  It suffers from confusion from bright night-sky</span>
<span class="sd">    lines and brighter objects.  These deficiencies led to the development of</span>
<span class="sd">    the iterative scrubber.  This code is kept here for historical purposes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : :obj:`~pathlib.Path`</span>
<span class="sd">        The name of the file to clean</span>
<span class="sd">    use_hann : :obj:`bool`</span>
<span class="sd">        Use a Hann window when cleaning the image for FFT (Default: False)</span>
<span class="sd">    sine_plot : :obj:`bool`</span>
<span class="sd">        Create a plot of the sinusoid pattern fits for this image?</span>
<span class="sd">        (Default: True)</span>
<span class="sd">    fft_plot : :obj:`bool`</span>
<span class="sd">        Create a plot of the FFT analysis for this image?</span>
<span class="sd">        (Default: False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read in the image and create copy arrays on which to work</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">nddata</span><span class="o">.</span><span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Check if this images has already been post-processed by this routine</span>
    <span class="k">if</span> <span class="s2">&quot;postproc&quot;</span> <span class="ow">in</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span> <span class="ow">and</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;postproc&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;deveny_pickup&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Skipping file </span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">; already processed with deveny_pickup&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Check image type; only process OBJECT and BIAS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">imgtyp</span> <span class="o">:=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;imagetyp&quot;</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OBJECT&quot;</span><span class="p">,</span> <span class="s2">&quot;BIAS&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Processing </span><span class="si">{</span><span class="n">imgtyp</span><span class="si">}</span><span class="s2"> file </span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Skipping </span><span class="si">{</span><span class="n">imgtyp</span><span class="si">}</span><span class="s2"> file </span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Get the expected pixel period from the FFT of the flattened array</span>
    <span class="n">pixel_period</span> <span class="o">=</span> <span class="n">flatten_clean_fft</span><span class="p">(</span>
        <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">use_hann</span><span class="o">=</span><span class="n">use_hann</span><span class="p">,</span> <span class="n">fft_plot</span><span class="o">=</span><span class="n">fft_plot</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This is the FFT-predicted pixel period: </span><span class="si">{</span><span class="n">pixel_period</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pix&quot;</span><span class="p">)</span>

    <span class="c1"># Compute the fit coefficients</span>
    <span class="n">fit_coeffs</span> <span class="o">=</span> <span class="n">fit_lines</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pixel_period</span><span class="p">)</span>

    <span class="c1"># Smooth the fit coefficients as a function of row to remove artifacts due</span>
    <span class="c1">#  to cosmic rays or strong sources.</span>
    <span class="c1"># NOTE: scipy.signal.medfilt() uses zero-padding for the ends of the signal,</span>
    <span class="c1">#       therefore subtract the mean and re-add it to eliminate edge weirdness</span>
    <span class="n">fit_coeffs</span><span class="p">[</span><span class="s2">&quot;smooth_a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth_array</span><span class="p">(</span><span class="n">fit_coeffs</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">])</span>
    <span class="n">fit_coeffs</span><span class="p">[</span><span class="s2">&quot;smooth_lambda&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth_array</span><span class="p">(</span><span class="n">fit_coeffs</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">])</span>
    <span class="n">fit_coeffs</span><span class="p">[</span><span class="s2">&quot;smooth_phi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth_array</span><span class="p">(</span><span class="n">fit_coeffs</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">],</span> <span class="n">ftype</span><span class="o">=</span><span class="s2">&quot;savgol&quot;</span><span class="p">)</span>
    <span class="c1"># Print a happy statement of fact</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;This is the mean fit pixel period: </span><span class="si">{</span><span class="n">fit_coeffs</span><span class="p">[</span><span class="s1">&#39;smooth_lambda&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pix&quot;</span>
    <span class="p">)</span>

    <span class="n">cleaned_array</span><span class="p">,</span> <span class="n">pattern_array</span> <span class="o">=</span> <span class="n">create_and_apply_pattern</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fit_coeffs</span><span class="p">)</span>

    <span class="c1"># Make a plot, if desired</span>
    <span class="k">if</span> <span class="n">sine_plot</span><span class="p">:</span>
        <span class="n">make_sinusoid_fit_plots</span><span class="p">(</span><span class="n">fit_coeffs</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">pixel_period</span><span class="p">)</span>

    <span class="n">package_into_fits</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">ccd</span><span class="p">,</span> <span class="n">cleaned_array</span><span class="p">,</span> <span class="n">pattern_array</span><span class="p">,</span> <span class="n">fit_coeffs</span><span class="p">,</span> <span class="n">pixel_period</span>
    <span class="p">)</span></div>



<span class="c1"># Task-Oriented Helper Functions =============================================#</span>
<div class="viewcode-block" id="flatten_clean_fft">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.flatten_clean_fft">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flatten_clean_fft</span><span class="p">(</span>
    <span class="n">data_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">use_hann</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fft_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">qa_dir</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_graphics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the peak frequency of sinusoidal noise</span>

<span class="sd">    The function name describes what it does:</span>
<span class="sd">        #. Flatten the 2D array into a 1D timeseries</span>
<span class="sd">        #. Clean the ends of the CCD for smoother transition</span>
<span class="sd">        #. Take the FFT to find the proper frequency to return</span>

<span class="sd">    In order to more effectively find the frequencies of persistent signal</span>
<span class="sd">    across the detector, start by flattening out the data array into a one-</span>
<span class="sd">    dimensional timeseries-like object representing the order in which the</span>
<span class="sd">    pixels are read out.</span>

<span class="sd">    According to information in Chapter 5 of `Scientific Charge-Coupled</span>
<span class="sd">    Devices` by James R. Janesick (2001), the time to advance a row along</span>
<span class="sd">    the parallel register is small compared to the individual pixel</span>
<span class="sd">    digitization time because the latter requires a capacitive stabilization</span>
<span class="sd">    time to minimize readnoise, whereas parallel register moves simply move</span>
<span class="sd">    the charge without trying to measure it.  Therefore, there is no spacing</span>
<span class="sd">    in between the rows of the flattened arrays to represent the time required</span>
<span class="sd">    for the parallel charge transfer.</span>

<span class="sd">    Once the array is flattened, we deal with row-to-row edge effects by</span>
<span class="sd">    modifying the flattened array to replace the 10 pixels at the end of one</span>
<span class="sd">    row and the 10 pixels at the start of the next row with a linearly varying</span>
<span class="sd">    series of values.  The first 10 and last 10 pixels of the flattened array</span>
<span class="sd">    are set to the next adjacent value.  This removes some of the &quot;ringing&quot;</span>
<span class="sd">    power at integer frequencies of an entire row and places it into the</span>
<span class="sd">    fundamental row-length frequency.  There are still sharp edges in the</span>
<span class="sd">    flattened array caused by night sky lines, but most of the power from these</span>
<span class="sd">    lines should be at the fundamental frequency (whole-row).</span>

<span class="sd">    The detected pickup noise has a period in the range 100-300 pixels, so</span>
<span class="sd">    peaks in the power spectrum at lower frequencies than this (`e.g.`, the</span>
<span class="sd">    fundamental row-length frequency) are masked when choosing the return</span>
<span class="sd">    value.</span>

<span class="sd">    Additionally, the assumption of continuous readout is close but not</span>
<span class="sd">    entriely accurate.  The slight pause in the readout caused by the parallel</span>
<span class="sd">    register readout causes the continuous readout amplifier pickup signal</span>
<span class="sd">    to manifest itself as a Gaussian packet of related frequencies in the FFT.</span>
<span class="sd">    By smoothing the power spectrum ( abs(FFT)^2 ) with a Gaussian kernel, narrow</span>
<span class="sd">    spikes in the FFT (caused by autocorrelation of night sky lines, cosmic</span>
<span class="sd">    rays, edge effects) are diluted compared to the sought signal.  The</span>
<span class="sd">    returned period is that of the maximum of the Gaussian-smoothed absolute</span>
<span class="sd">    value squared.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_array : :obj:`~numpy.ndarray`</span>
<span class="sd">        _description_</span>
<span class="sd">    use_hann : :obj:`bool`</span>
<span class="sd">        Use a Hann window on each row in addition to subtracting the row mean</span>
<span class="sd">        (Default: False)</span>
<span class="sd">    fft_plot : :obj:`bool`</span>
<span class="sd">        Create a debugging plot of the FFT analysis?  (Default: False)</span>
<span class="sd">    qa_dir : :obj:`~pathlib.Path`, optional</span>
<span class="sd">        The QA directory into which to place the optional plots.  If ``None``,</span>
<span class="sd">        the plots will be placed in the current working directory.</span>
<span class="sd">        (Default: None)</span>
<span class="sd">    filename : :obj:`~pathlib.Path`</span>
<span class="sd">        The filename of the raw data frame for the optional plot.  (Default: None)</span>
<span class="sd">    extra_graphics : :obj:`bool`, optional</span>
<span class="sd">        Produce extra graphics formats for documentation?  (Default: False)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`float`</span>
<span class="sd">        The pixel period of the sinusoidal oscillation to be removed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Compute the shape of the input array</span>
    <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># If so desired, apply a Hann window to each row</span>
    <span class="k">if</span> <span class="n">use_hann</span><span class="p">:</span>
        <span class="n">hann</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncol</span><span class="p">)</span> <span class="o">/</span> <span class="n">ncol</span><span class="p">))</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_array</span> <span class="o">*</span> <span class="n">hann</span>

    <span class="c1"># Flatten the array; force Column-Major to keep python from getting ideas</span>
    <span class="n">flat_array</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># Smooth out the beginning of the first and end of the last rows</span>
    <span class="n">flat_array</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">flat_array</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">flat_array</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span> <span class="o">=</span> <span class="n">flat_array</span><span class="p">[</span><span class="o">-</span><span class="mi">11</span><span class="p">]</span>

    <span class="c1"># For all other row breaks, index by `rownum``</span>
    <span class="k">for</span> <span class="n">rownum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrow</span><span class="p">):</span>
        <span class="c1"># Build up a slice</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">rownum</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">-</span> <span class="mi">10</span> <span class="p">:</span> <span class="n">rownum</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span>
        <span class="c1"># Pull the chunk and replace it with something smooth</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">flat_array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">flat_array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>

    <span class="c1"># Use sigma-clipped stats to remove wild swings that may affect the FFT</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">med</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">flat_array</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
    <span class="n">clip_ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">flat_array</span> <span class="o">&gt;</span> <span class="n">med</span> <span class="o">+</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">flat_array</span> <span class="o">&lt;</span> <span class="n">med</span> <span class="o">-</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>
    <span class="n">flat_array</span><span class="p">[</span><span class="n">clip_ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Onward to the FFT!</span>
    <span class="c1"># Subtract the mean to remove power from 0 frequency</span>
    <span class="n">y_fft</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">flat_array</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flat_array</span><span class="p">))</span>

    <span class="c1"># Compute the frequency array; N = N points, T = Spacing (PIX_DWELL)</span>
    <span class="n">x_fft</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">n_pts</span> <span class="o">:=</span> <span class="n">flat_array</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">PIX_DWELL</span><span class="p">)</span>

    <span class="c1"># Mask out periods longer than ~500 pixels (this also removes negative freq&#39;s)</span>
    <span class="n">y_fft</span><span class="p">[</span><span class="n">x_fft</span> <span class="o">&lt;</span> <span class="n">pixper_tofrom_hz</span><span class="p">(</span><span class="mi">500</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Compute the power spectrum, smoothed with a 10-Hz Gaussian</span>
    <span class="n">pspec</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_fft</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Find the peak of the smoothed power spectrum, seeking Gaussin packets</span>
    <span class="n">peak_freq</span> <span class="o">=</span> <span class="n">x_fft</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pspec</span><span class="p">[:</span> <span class="n">n_pts</span> <span class="o">//</span> <span class="mi">2</span><span class="p">])]</span>

    <span class="k">if</span> <span class="n">fft_plot</span><span class="p">:</span>
        <span class="n">create_fft_plot</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="n">flat_array</span><span class="p">,</span>
            <span class="n">y_fft</span><span class="p">,</span>
            <span class="n">x_fft</span><span class="p">,</span>
            <span class="n">peak_freq</span><span class="p">,</span>
            <span class="n">qa_dir</span><span class="o">=</span><span class="n">qa_dir</span><span class="p">,</span>
            <span class="n">extra_graphics</span><span class="o">=</span><span class="n">extra_graphics</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Return the period (in pixels) that corresponds to this frequency</span>
    <span class="k">return</span> <span class="n">pixper_tofrom_hz</span><span class="p">(</span><span class="n">peak_freq</span><span class="p">)</span></div>



<div class="viewcode-block" id="fit_lines">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.fit_lines">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fit_lines</span><span class="p">(</span>
    <span class="n">data_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">pixel_period</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">orig_fitc</span><span class="p">:</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">refit_thresh_sig</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
    <span class="n">trim_ends</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">objmodel_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">show_diagnostic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fixed_sinusoid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit a sinusoid to each line in the image</span>

<span class="sd">    This is like a mini-driver function that fits a sinusoid to each line in</span>
<span class="sd">    the image.</span>

<span class="sd">    It also can refit lines that have excessive RMS residual as compared to the</span>
<span class="sd">    bulk of the image.  To enable the refitting, pass in the fit coefficient</span>
<span class="sd">    table from the first fitting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_array : :obj:`~numpy.ndarray`</span>
<span class="sd">        The image array to be processed.  This should be HORIZONTAL and in the</span>
<span class="sd">        same orientation as images written out by lois directly from the</span>
<span class="sd">        instrument.</span>
<span class="sd">    pixel_period : :obj:`float`</span>
<span class="sd">        The predicted pixel period for this image array, as computed by</span>
<span class="sd">        :func:`flatten_clean_fft`.</span>
<span class="sd">    orig_fitc : :obj:`~astropy.table.Table`, optional</span>
<span class="sd">        If refitting, the first-pass fit coefficient table.  If absent, then a</span>
<span class="sd">        full fitting of all lines will be performed.  (Default: None)</span>
<span class="sd">    refit_thresh_sig : :obj:`float`, optional</span>
<span class="sd">        Threshold for RMS deviation (in sigma-clipped standard deviation units)</span>
<span class="sd">        from the mean for a line to be refit.  (Default: 3.0)</span>
<span class="sd">    trim_ends : :obj:`bool`, optional</span>
<span class="sd">        Trim the 5 pixels off the ends of the line before fitting?</span>
<span class="sd">        (Default: True)</span>
<span class="sd">    objmodel_check : :obj:`bool`, optional</span>
<span class="sd">        Is this image the spec2d objmodel?  (Default: False)</span>
<span class="sd">    show_diagnostic : :obj:`bool`, optional</span>
<span class="sd">        Display a diagnotic plot of several lines w/ fit?  (Default: False)</span>
<span class="sd">    fixed_sinusoid : :obj:`bool`, optional</span>
<span class="sd">        Determine the (roughly) constant sinusoid amplitude and period and fit</span>
<span class="sd">        the lines for phase and secular drift only?  (Default: False)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`~astropy.table.Table`</span>
<span class="sd">        A table object containing the fit coefficients, one table row per row</span>
<span class="sd">        of the input ``data_array``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Array shape</span>
    <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">img_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span>

    <span class="c1"># If refitting, determine the rows with good rms and those needing refit</span>
    <span class="c1">#  Refitting is done if `orig_fitc` is passed in, but not if</span>
    <span class="c1">#  `fixed_sinusoid` or `objmodel_check` is checked.</span>
    <span class="k">if</span> <span class="n">do_refit</span> <span class="o">:=</span> <span class="p">(</span><span class="n">orig_fitc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">fixed_sinusoid</span> <span class="ow">or</span> <span class="n">objmodel_check</span><span class="p">)):</span>
        <span class="c1"># =================================#</span>
        <span class="c1"># Find lines with &quot;bad&quot; RMS or with very small amplitude and non-zero RMS,</span>
        <span class="c1">#   then refit those lines using tight priors based on adjacent lines</span>
        <span class="n">avg</span><span class="p">,</span> <span class="n">med</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">],</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_diagnostic</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stats: mean = </span><span class="si">{</span><span class="n">avg</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">  median = </span><span class="si">{</span><span class="n">med</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">  stddev = </span><span class="si">{</span><span class="n">std</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Cap the used STD at 0.2 for identifying lines needing refitting</span>
        <span class="n">std</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>

        <span class="c1"># Indices of rows with &quot;good&quot; RMS and those needing refitting</span>
        <span class="n">ind_goodrms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span>
            <span class="p">(</span><span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">avg</span> <span class="o">-</span> <span class="n">refit_thresh_sig</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">avg</span> <span class="o">+</span> <span class="n">refit_thresh_sig</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">refit_lines</span> <span class="o">=</span> <span class="p">(</span><span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">avg</span> <span class="o">+</span> <span class="n">refit_thresh_sig</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">show_diagnostic</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Total elements: </span><span class="si">{</span><span class="n">nrow</span><span class="si">}</span><span class="s2">  Good RMS:  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ind_goodrms</span><span class="p">)</span><span class="si">}</span><span class="s2">  &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Refit lines: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">refit_lines</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># If there are no &quot;good&quot; RMS values, cannot refit.  Return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_goodrms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No good fit values to use for start of refitting.  Skip.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">orig_fitc</span>

    <span class="c1"># Checking the object model for sinusoidal pattern noise</span>
    <span class="k">if</span> <span class="n">objmodel_check</span><span class="p">:</span>
        <span class="n">ind_obj</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">data_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ncol</span><span class="p">))</span>
        <span class="p">]</span>

    <span class="c1"># If fitting a (roughly) constant sinusoid to all lines, determine the</span>
    <span class="c1">#  (slowly varying) values of amplitude and period as a function of row</span>
    <span class="c1">#  number by fitting a line to the orig_fitc using a linear least-squares</span>
    <span class="c1">#  algorithm.</span>
    <span class="k">if</span> <span class="n">fixed_sinusoid</span><span class="p">:</span>
        <span class="c1"># Valid range is the whole slit -- fill in any odd gaps</span>
        <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">))[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">valid_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">valid_idx</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Fit Chebyshev polynomials to these two coefficients as a f(row)</span>
        <span class="n">row_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nrow</span><span class="p">)</span>
        <span class="n">p_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Chebyshev</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">row_num</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">],</span> <span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][</span><span class="n">valid_idx</span><span class="p">],</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">p_lambda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Chebyshev</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">row_num</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">],</span> <span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="n">valid_idx</span><span class="p">],</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">fixed_a</span> <span class="o">=</span> <span class="n">p_a</span><span class="p">(</span><span class="n">row_num</span><span class="p">)</span>
        <span class="n">fixed_lambda</span> <span class="o">=</span> <span class="n">p_lambda</span><span class="p">(</span><span class="n">row_num</span><span class="p">)</span>

    <span class="c1"># ======== Begin Actual Fitting ============#</span>
    <span class="c1"># These are the starting guesses and bounds for the sinusoidal fit</span>
    <span class="c1">#  [a, lam, phi, y0, lin, quad]</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="n">pixel_period</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">img_mean</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">pixel_period</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">img_mean</span> <span class="o">-</span> <span class="mi">100</span><span class="p">,</span>
            <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
            <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="n">pixel_period</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">img_mean</span> <span class="o">+</span> <span class="mi">100</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Set up the fit_coeffs list based on fitting mode</span>
    <span class="n">fit_coeffs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># Back-convert the Table to a list of dictionaries</span>
        <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">orig_fitc</span><span class="o">.</span><span class="n">colnames</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">orig_fitc</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">do_refit</span> <span class="ow">or</span> <span class="n">fixed_sinusoid</span>
        <span class="c1"># Start with an empty list</span>
        <span class="k">else</span> <span class="p">[]</span>
    <span class="p">)</span>

    <span class="c1"># Create a progress bar for every occasion!</span>
    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">total</span><span class="o">=</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">refit_lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">do_refit</span>
            <span class="k">else</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">ind_obj</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">objmodel_check</span>
                <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">)</span> <span class="k">if</span> <span class="n">fixed_sinusoid</span> <span class="k">else</span> <span class="n">nrow</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">colour</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;#87EBCF&quot;</span>
            <span class="k">if</span> <span class="n">do_refit</span>
            <span class="k">else</span> <span class="p">(</span>
                <span class="s2">&quot;#EBC687&quot;</span>
                <span class="k">if</span> <span class="n">objmodel_check</span>
                <span class="k">else</span> <span class="s2">&quot;#EB89EB&quot;</span> <span class="k">if</span> <span class="n">fixed_sinusoid</span> <span class="k">else</span> <span class="s2">&quot;#87CEEB&quot;</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="p">,</span>
        <span class="n">unit_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Prepare the line diagnostic plot</span>
    <span class="k">if</span> <span class="n">show_diagnostic</span><span class="p">:</span>
        <span class="c1"># Make a diagnostic plot</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="n">tsz</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">pidx</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Loop over the rows in the image to fit the pattern</span>
    <span class="n">xpl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncol</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">img_row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span><span class="p">):</span>
        <span class="c1"># If refitting, follow this logic:</span>
        <span class="k">if</span> <span class="n">do_refit</span><span class="p">:</span>
            <span class="c1"># If not refitting this line, move along</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">refit_lines</span><span class="p">[</span><span class="n">img_row</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="c1"># Estimate the parameters more specifically from the &quot;good&quot; rms</span>
            <span class="c1">#   lines in the vicinity</span>
            <span class="n">closest_idx</span> <span class="o">=</span> <span class="n">ind_goodrms</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img_row</span> <span class="o">-</span> <span class="n">ind_goodrms</span><span class="p">))]</span>
            <span class="c1"># Amplitude</span>
            <span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][</span><span class="n">closest_idx</span><span class="p">]</span>
            <span class="c1"># Period</span>
            <span class="n">p0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="n">closest_idx</span><span class="p">]</span>
            <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="n">closest_idx</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span>
            <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_fitc</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">][</span><span class="n">closest_idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span>

        <span class="k">if</span> <span class="n">fixed_sinusoid</span><span class="p">:</span>
            <span class="c1"># If not setting a fixed value, move along</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_idx</span><span class="p">[</span><span class="n">img_row</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="c1"># Set the parameters for the fixed parameters</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.0e-4</span>
            <span class="c1"># Amplitude</span>
            <span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_a</span><span class="p">[</span><span class="n">img_row</span><span class="p">]</span>
            <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_a</span><span class="p">[</span><span class="n">img_row</span><span class="p">]</span> <span class="o">-</span> <span class="n">epsilon</span>
            <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_a</span><span class="p">[</span><span class="n">img_row</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span>
            <span class="c1"># Period</span>
            <span class="n">p0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_lambda</span><span class="p">[</span><span class="n">img_row</span><span class="p">]</span>
            <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_lambda</span><span class="p">[</span><span class="n">img_row</span><span class="p">]</span> <span class="o">-</span> <span class="n">epsilon</span>
            <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_lambda</span><span class="p">[</span><span class="n">img_row</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span>

        <span class="k">if</span> <span class="n">objmodel_check</span><span class="p">:</span>
            <span class="c1"># If looking for object model, skip lines without the object model</span>
            <span class="k">if</span> <span class="n">img_row</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ind_obj</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">trim_ends</span><span class="p">:</span>
            <span class="c1"># Pull this line, minus the last few pixels at each end</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[</span><span class="n">img_row</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use the entire line</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[</span><span class="n">img_row</span><span class="p">]</span>

        <span class="c1"># To mitigate cosmic rays and night sky lines, sigma clip @ 5σ</span>
        <span class="n">sig_clip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">*</span> <span class="mf">5.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">line</span><span class="p">[</span><span class="n">line</span> <span class="o">&gt;</span> <span class="n">sig_clip</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig_clip</span>

        <span class="c1"># Smooth the line with a median filter at 1/10th the pixel period</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">smooth_array</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">nearest_odd</span><span class="p">(</span><span class="n">pixel_period</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">))</span>

        <span class="c1"># Perform the curve fit</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If the line is identically zero, don&#39;t fit</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">line</span><span class="p">)):</span>
                <span class="n">popt</span> <span class="o">=</span> <span class="n">p0</span>
                <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">popt</span><span class="p">)))</span>
                <span class="n">infodict</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">ier</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fvec&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s2">&quot;Identically Zero&quot;</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The optimization method is the &quot;Trust Region Reflective&quot; algorithm</span>
                <span class="c1"># The parameters are scaled iteratively from the Jacobian matrix</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">ier</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">sinusoid</span><span class="p">,</span>
                    <span class="n">xpl</span><span class="p">,</span>
                    <span class="n">line</span><span class="p">,</span>
                    <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span>
                    <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                    <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;trf&quot;</span><span class="p">,</span>
                    <span class="n">x_scale</span><span class="o">=</span><span class="s2">&quot;jac&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">infodict</span><span class="p">[</span><span class="s2">&quot;fvec&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="c1"># Reached max function evaluations; set popt and pcov</span>
            <span class="n">popt</span> <span class="o">=</span> <span class="n">p0</span>
            <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">popt</span><span class="p">)))</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">infodict</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">ier</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fvec&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="s2">&quot;Runtime Error&quot;</span><span class="p">,</span> <span class="mi">0</span>

        <span class="c1"># Diagnositc Plot showing particular rows ==========&gt;</span>
        <span class="k">if</span> <span class="n">show_diagnostic</span> <span class="ow">and</span> <span class="n">img_row</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">76</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">285</span><span class="p">,</span> <span class="mi">412</span><span class="p">]:</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">pidx</span><span class="p">]</span>
            <span class="c1"># Add this to the plot</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xpl</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="s2">&quot;k-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">xpl</span><span class="p">,</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">sinusoid</span><span class="p">(</span><span class="n">xpl</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">),</span>
                <span class="s2">&quot;r-&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">make_sine_label</span><span class="p">(</span><span class="n">popt</span><span class="p">,</span> <span class="n">infodict</span><span class="p">,</span> <span class="n">mesg</span><span class="p">,</span> <span class="n">ier</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">set_std_tickparams</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">tsz</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pixel Position, Row #</span><span class="si">{</span><span class="n">img_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>
            <span class="n">pidx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Compute standard deviations and correlation matrix</span>
        <span class="n">pstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">))</span>
        <span class="c1"># Check for zero stddev, replace with small stddev</span>
        <span class="n">pstd</span><span class="p">[</span><span class="n">pstd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e-8</span>
        <span class="n">inv_pstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pstd</span><span class="p">))</span>
        <span class="n">pcor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">inv_pstd</span><span class="p">,</span> <span class="n">pcov</span><span class="p">),</span> <span class="n">inv_pstd</span><span class="p">)</span>

        <span class="c1"># Add the fit coefficients to the list</span>
        <span class="n">coeff_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;a_err&quot;</span><span class="p">:</span> <span class="n">pstd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;lambda&quot;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;lambda_err&quot;</span><span class="p">:</span> <span class="n">pstd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;phi_err&quot;</span><span class="p">:</span> <span class="n">pstd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;y0&quot;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s2">&quot;y0_err&quot;</span><span class="p">:</span> <span class="n">pstd</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s2">&quot;corr_a_lambda&quot;</span><span class="p">:</span> <span class="n">pcor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;corr_a_phi&quot;</span><span class="p">:</span> <span class="n">pcor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;corr_a_y0&quot;</span><span class="p">:</span> <span class="n">pcor</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
            <span class="s2">&quot;corr_lambda_phi&quot;</span><span class="p">:</span> <span class="n">pcor</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;corr_lambda_y0&quot;</span><span class="p">:</span> <span class="n">pcor</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
            <span class="s2">&quot;corr_phi_y0&quot;</span><span class="p">:</span> <span class="n">pcor</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
            <span class="s2">&quot;rms&quot;</span><span class="p">:</span> <span class="n">rms</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">do_refit</span> <span class="ow">or</span> <span class="n">fixed_sinusoid</span><span class="p">:</span>
            <span class="c1"># Replace the existing row in the table with the new dictionary</span>
            <span class="n">fit_coeffs</span><span class="p">[</span><span class="n">img_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Append the dictionary to the list</span>
            <span class="n">fit_coeffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coeff_dict</span><span class="p">)</span>

        <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># End of the loop; close out the diagnostic plot</span>
    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">show_diagnostic</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Convert the list of dict into a Table for return (optionally return smoothing coef)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">fit_coeffs</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;p_a&quot;</span><span class="p">:</span> <span class="n">p_a</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="s2">&quot;p_lambda&quot;</span><span class="p">:</span> <span class="n">p_lambda</span><span class="o">.</span><span class="n">coef</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">fixed_sinusoid</span>
        <span class="k">else</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">fit_coeffs</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="smooth_array">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.smooth_array">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">smooth_array</span><span class="p">(</span>
    <span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span> <span class="n">ftype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Smooth out an array with a given filter</span>

<span class="sd">    This may be used for smoothing a line or attempting to smooth fit</span>
<span class="sd">    coefficients from row to row in order to ameliorate the effects of cosmic</span>
<span class="sd">    rays and strong sources.</span>

<span class="sd">    .. note::</span>

<span class="sd">        :func:`scipy.signal.medfilt` uses zero-padding for the ends of the</span>
<span class="sd">        signal, therefore subtract the mean and re-add it to eliminate edge</span>
<span class="sd">        weirdness.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array : :obj:`~numpy.ndarray`</span>
<span class="sd">        The array to be smoothed.</span>
<span class="sd">    kernel_size : :obj:`int`, optional</span>
<span class="sd">        Kernel or window size for the smoothing function (Default: 21)</span>
<span class="sd">    ftype : :obj:`str`, optional</span>
<span class="sd">        Smoothing function to use.  Options are &quot;median&quot; and &quot;savgol&quot;.</span>
<span class="sd">        (Default: &quot;median&quot;)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`~numpy.ndarray`</span>
<span class="sd">        The smoothed coefficients</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">medfilt</span><span class="p">(</span>
                <span class="n">array</span> <span class="o">-</span> <span class="p">(</span><span class="n">med</span> <span class="o">:=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">array</span><span class="p">)),</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="n">med</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;savgol&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span>
            <span class="n">array</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span>
        <span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filter type </span><span class="si">{</span><span class="n">ftype</span><span class="si">}</span><span class="s2"> not supported by this function.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_and_apply_pattern">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.create_and_apply_pattern">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_and_apply_pattern</span><span class="p">(</span>
    <span class="n">input_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fit_coeffs</span><span class="p">:</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct the pattern from the fit coefficients</span>

<span class="sd">    .. note::</span>

<span class="sd">        The returned ``pattern_array`` has a mean = 0 (*i.e.*, the pattern is</span>
<span class="sd">        constructed from the pure sinusoid w/o offset or other additive terms).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_array : :obj:`~numpy.ndarray`</span>
<span class="sd">        The input array to be cleaned</span>
<span class="sd">    fit_coeffs : :obj:`~astropy.table.Table`</span>
<span class="sd">        The fit coefficient table produced by :func:`fit_lines`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cleaned_array : :obj:`~numpy.ndarray`</span>
<span class="sd">        The cleaned sience array</span>
<span class="sd">    pattern_array : :obj:`~numpy.ndarray`</span>
<span class="sd">        The pattern removed from ``input_array`` -- mean = 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the arrays that the processed data will go into</span>
    <span class="n">cleaned_array</span> <span class="o">=</span> <span class="n">input_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">pattern_array</span> <span class="o">=</span> <span class="n">input_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># Loop through the image and use the smoothed sinusoid fit coefficients</span>
    <span class="k">for</span> <span class="n">img_row</span><span class="p">,</span> <span class="n">table_row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fit_coeffs</span><span class="p">):</span>
        <span class="c1"># Apply the adjusted pattern to the entire row</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">input_array</span><span class="p">[</span><span class="n">img_row</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Compute the pattern</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">sinusoid</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
            <span class="n">table_row</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span>
            <span class="n">table_row</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">],</span>
            <span class="n">table_row</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">],</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Fill in the new arrays with the cleaned data and pattern</span>
        <span class="n">cleaned_array</span><span class="p">[</span><span class="n">img_row</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">line</span> <span class="o">-</span> <span class="n">pattern</span>
        <span class="n">pattern_array</span><span class="p">[</span><span class="n">img_row</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">pattern</span>

    <span class="c1"># Return when done</span>
    <span class="k">return</span> <span class="n">cleaned_array</span><span class="p">,</span> <span class="n">pattern_array</span></div>



<div class="viewcode-block" id="package_into_fits">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.package_into_fits">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">package_into_fits</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
    <span class="n">ccd</span><span class="p">:</span> <span class="n">astropy</span><span class="o">.</span><span class="n">nddata</span><span class="o">.</span><span class="n">CCDData</span><span class="p">,</span>
    <span class="n">cleaned_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">pattern_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">fit_coeffs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">pixel_period</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">overwrite_raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Package the cleaned data into a FITS file</span>

<span class="sd">    Package everything into a multiextension FITS file:</span>

<span class="sd">    0. Primary HDU -- contains the raw file&#39;s FITS header</span>
<span class="sd">    1. Cleaned Image HDU -- raw - pattern</span>
<span class="sd">    2. Original Image HDU -- raw</span>
<span class="sd">    3. Pattern Image HDU -- pattern</span>
<span class="sd">    4. Pattern about Raw Mean Image HDU -- pattern + mean(raw)</span>
<span class="sd">    5. Fit Coefficients BinTable HDU -- fit_coeffs</span>

<span class="sd">    The output filename is the same (including path) as the input raw file,</span>
<span class="sd">    but with &quot;_scrub&quot; appended before &quot;.fits&quot;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : :obj:`~pathlib.Path`</span>
<span class="sd">        The filename of the raw data frame</span>
<span class="sd">    ccd : :obj:`~astropy.nddata.CCDData`</span>
<span class="sd">        The raw data object</span>
<span class="sd">    cleaned_array : :obj:`~numpy.ndarray`</span>
<span class="sd">        The cleaned raw data array (raw data - pattern) in ADU</span>
<span class="sd">    pattern_array : :obj:`~numpy.ndarray`</span>
<span class="sd">        The computed pattern array in ADU</span>
<span class="sd">    fit_coeffs : :obj:`dict`</span>
<span class="sd">        The fit coefficients dictionary from :func:`fit_lines`</span>
<span class="sd">    pixel_period : :obj:`float`</span>
<span class="sd">        The FFT-computed pixel period from :func:`flatten_clean_fft`</span>
<span class="sd">    overwrite_raw : :obj:`bool`, optional</span>
<span class="sd">        Overwrite the raw file rather than create a new file with the &#39;_scrub&#39;</span>
<span class="sd">        suffix  (Default: False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add a little history</span>
    <span class="n">time_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">timespec</span><span class="o">=</span><span class="s2">&quot;seconds&quot;</span><span class="p">)</span>
    <span class="n">history_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Written by package obstools: </span><span class="si">{</span><span class="n">time_str</span><span class="si">}</span><span class="s2"> UTC&quot;</span>
    <span class="c1"># For the image HDUs, include a basic header</span>
    <span class="n">img_hdr</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">({</span><span class="s2">&quot;BUNIT&quot;</span><span class="p">:</span> <span class="s2">&quot;ADU&quot;</span><span class="p">,</span> <span class="s2">&quot;HISTORY&quot;</span><span class="p">:</span> <span class="n">history_str</span><span class="p">})</span>

    <span class="c1"># Primary HDU: #0 -- Construct from raw header plus new keywords</span>
    <span class="n">primary_hdu</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">primary_hdu</span><span class="o">.</span><span class="n">update_header</span><span class="p">()</span>
    <span class="n">primary_hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="s2">&quot;postproc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scrub_deveny_pickup&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Post-processing algorithm or package applied&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">primary_hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="s2">&quot;post_ext&quot;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;Extension holding post-processed image (zero-indexed)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">primary_hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HISTORY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">history_str</span>

    <span class="c1"># Image HDU: #1 -- Cleaned Image</span>
    <span class="n">clean_hdu</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span>
        <span class="n">astropy</span><span class="o">.</span><span class="n">nddata</span><span class="o">.</span><span class="n">CCDData</span><span class="p">(</span><span class="n">cleaned_array</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CLEANED&quot;</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">img_hdr</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">primary_hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;EXT0001&quot;</span><span class="p">,</span> <span class="s2">&quot;CLEANED&quot;</span><span class="p">,</span> <span class="s2">&quot;Cleaned Image (raw - pattern)&quot;</span><span class="p">))</span>

    <span class="c1"># Image HDU: #2 -- Original (Raw) Frame</span>
    <span class="n">orig_hdu</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ORIGINAL&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">img_hdr</span><span class="p">)</span>
    <span class="n">primary_hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;EXT0002&quot;</span><span class="p">,</span> <span class="s2">&quot;ORIGINAL&quot;</span><span class="p">,</span> <span class="s2">&quot;Original Image (raw)&quot;</span><span class="p">))</span>

    <span class="c1"># Image HDU: #3 -- Pattern Image (mean = 0)</span>
    <span class="n">pattern0_hdu</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span>
        <span class="n">astropy</span><span class="o">.</span><span class="n">nddata</span><span class="o">.</span><span class="n">CCDData</span><span class="p">(</span><span class="n">pattern_array</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PATTERN0&quot;</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">img_hdr</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">primary_hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;EXT0003&quot;</span><span class="p">,</span> <span class="s2">&quot;PATTERN0&quot;</span><span class="p">,</span> <span class="s2">&quot;Pickup Noise Pattern (zero mean)&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Image HDU: #4 -- Pattern Image about Raw Mean (mean = mean(raw))</span>
    <span class="n">pattern1_hdu</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">(</span>
        <span class="n">astropy</span><span class="o">.</span><span class="n">nddata</span><span class="o">.</span><span class="n">CCDData</span><span class="p">(</span><span class="n">pattern_array</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PATTERN1&quot;</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="n">img_hdr</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">primary_hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;EXT0004&quot;</span><span class="p">,</span> <span class="s2">&quot;PATTERN1&quot;</span><span class="p">,</span> <span class="s2">&quot;Pickup Noise Pattern (image mean)&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># BinTable HDU: #5 -- Sinusoid Fit Coefficients</span>
    <span class="n">table_hdu</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="p">(</span><span class="n">fit_coeffs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;FIT DATA&quot;</span><span class="p">)</span>
    <span class="n">table_hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="s2">&quot;fft_per&quot;</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">pixel_period</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;Pattern periodicity computed from FFT (pixels)&quot;</span><span class="p">,</span>
        <span class="n">before</span><span class="o">=</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">table_hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="s2">&quot;mean_per&quot;</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">fit_coeffs</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;Mean fit pattern periodicity (pixels)&quot;</span><span class="p">,</span>
        <span class="n">before</span><span class="o">=</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">table_hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="s2">&quot;mean_amp&quot;</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">fit_coeffs</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
        <span class="s2">&quot;Median pattern peak-to-peak amplitude (ADU)&quot;</span><span class="p">,</span>
        <span class="n">before</span><span class="o">=</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fit_coeffs</span><span class="o">.</span><span class="n">colnames</span> <span class="k">if</span> <span class="s2">&quot;corr_&quot;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]:</span>
        <span class="n">table_hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">col</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">fit_coeffs</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)),</span>
            <span class="s2">&quot;Median correlation coeff between parameters&quot;</span><span class="p">,</span>
            <span class="n">before</span><span class="o">=</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">table_hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Table contains the sinusoid fit coefficients for each row of the image&quot;</span>
    <span class="p">)</span>
    <span class="n">table_hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;HISTORY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">history_str</span>
    <span class="n">primary_hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;EXT0004&quot;</span><span class="p">,</span> <span class="s2">&quot;FIT DATA&quot;</span><span class="p">,</span> <span class="s2">&quot;Fit coefficients per line&quot;</span><span class="p">))</span>

    <span class="c1"># Assemble the whole thing into an HDUList and write to disk</span>
    <span class="n">hdul</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span>
        <span class="p">[</span><span class="n">primary_hdu</span><span class="p">,</span> <span class="n">clean_hdu</span><span class="p">,</span> <span class="n">orig_hdu</span><span class="p">,</span> <span class="n">pattern0_hdu</span><span class="p">,</span> <span class="n">pattern1_hdu</span><span class="p">,</span> <span class="n">table_hdu</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># Output filename is the same as the original, with &quot;_scrub&quot; appended before &quot;.fits&quot;</span>
    <span class="n">out_fn</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">filename</span><span class="o">.</span><span class="n">with_stem</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_scrub&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite_raw</span> <span class="k">else</span> <span class="n">filename</span>
    <span class="p">)</span>

    <span class="c1"># Print a helpful statement</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing out scrubbed FITS file: </span><span class="si">{</span><span class="n">out_fn</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">out_fn</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<span class="c1"># Plotting Functions for QA / Debugging ======================================#</span>
<div class="viewcode-block" id="create_fft_plot">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.create_fft_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_fft_plot</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
    <span class="n">flat_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y_fft</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">x_fft</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">peak_freq</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">qa_dir</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_graphics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the FFT analysis plot</span>

<span class="sd">    This function creates a multipanel plot saved as ``fft_analysis.pdf`` in</span>
<span class="sd">    the current working directory.  The panels are:</span>

<span class="sd">    1. The flattened time-like array, where pixels are in the order in which</span>
<span class="sd">       they were read out by the CCD electronics.</span>
<span class="sd">    2. The real part of the FFT of the flattened array, where the abscissa is</span>
<span class="sd">       shown as the sinusoid period in pixels.</span>
<span class="sd">    3. The imaginary part of the FFT of the flattened array, where the abscissa</span>
<span class="sd">       is shown as the sinusoid period in pixels.</span>
<span class="sd">    4. The absolute value squared of the FFT of the flattened array, to show</span>
<span class="sd">       the power as a function of frequency.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : :obj:`~pathlib.Path`</span>
<span class="sd">        The filename of the raw data frame</span>
<span class="sd">    flat_array : :obj:`~numpy.ndarray`</span>
<span class="sd">        The flattened (1D) pixel array</span>
<span class="sd">    y_fft : :obj:`~numpy.ndarray`</span>
<span class="sd">        The (complex) FFT values</span>
<span class="sd">    x_fft : :obj:`~numpy.ndarray`</span>
<span class="sd">        The FFT frequencies for the values in ``y_fft``</span>
<span class="sd">    peak_freq : :obj:`float`</span>
<span class="sd">        The peak frequency measured from the FFT</span>
<span class="sd">    qa_dir : :obj:`~pathlib.Path`, optional</span>
<span class="sd">        The QA directory into which to place the optional plots.  If ``None``,</span>
<span class="sd">        the plots will be placed in the current working directory.</span>
<span class="sd">        (Default: None)</span>
<span class="sd">    extra_graphics : :obj:`bool`, optional</span>
<span class="sd">        Produce extra graphics formats for documentation?  (Default: False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ignore UserWarnings in this function</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

    <span class="c1"># Compute the power spectrum as |FFT|^2; smoothed with a 10-Hz Gaussian</span>
    <span class="n">pspec</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_fft</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Set up the plotting environment -- somewhat complicated, but pretty</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mf">6.4</span><span class="p">))</span>
    <span class="n">gs0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">])</span>

    <span class="c1"># Lay out the gridspec and map to the usual Axis objects for plotting</span>
    <span class="n">gs00</span> <span class="o">=</span> <span class="n">gs0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subgridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">gs01</span> <span class="o">=</span> <span class="n">gs0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">subgridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">axis0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs00</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axis1</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs01</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="n">tsz</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="c1"># Linear Pixels -- separate thing</span>
    <span class="n">axis0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">flat_array</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">axis0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Linear pixel number&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>
    <span class="n">axis0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Pixel Value (electron)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">set_std_tickparams</span><span class="p">(</span><span class="n">axis0</span><span class="p">,</span> <span class="n">tsz</span><span class="p">)</span>

    <span class="c1"># Limits and Labels</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">med</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">flat_array</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
    <span class="n">axis0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">med</span> <span class="o">-</span> <span class="mf">20.0</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">med</span> <span class="o">+</span> <span class="mf">20.0</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>
    <span class="n">axis0</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;plain&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="c1"># When making plots for the documentation, obfuscate the source</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">extra_graphics</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot; for </span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">axis0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FFT Analysis</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># FFT plots, on common x-axis</span>
    <span class="c1"># Make a series of secondary axes</span>
    <span class="n">secaxes</span> <span class="o">=</span> <span class="n">axis1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">axis1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">x_fft</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">y_fft</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Real Component of the FFT&quot;</span>
    <span class="p">)</span>
    <span class="n">axis1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Re(FFT)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>
    <span class="n">axis1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>

    <span class="n">axis1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">x_fft</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">y_fft</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Imaginary Component of the FFT&quot;</span>
    <span class="p">)</span>
    <span class="n">axis1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Im(FFT)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>
    <span class="n">axis1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>

    <span class="n">axis1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">x_fft</span><span class="p">,</span>
        <span class="n">pspec</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Smoothed Power Spectrum (10-Hz Kernel)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ylim</span> <span class="o">=</span> <span class="n">axis1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="n">axis1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">x_fft</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_fft</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Raw FFT Power Spectrum&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axis1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;|FFT|^2&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>
    <span class="n">axis1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="n">axis1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>
    <span class="n">axis1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="mf">0.05</span><span class="p">,</span>
        <span class="mf">0.95</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Peak @ </span><span class="si">{</span><span class="n">pixper_tofrom_hz</span><span class="p">(</span><span class="n">peak_freq</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pix&quot;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">axis1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">,</span>
        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">secax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">axis1</span><span class="p">,</span> <span class="n">secaxes</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Do the frequency-based parts</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">pixper_tofrom_hz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">500</span><span class="p">,</span> <span class="mi">75</span><span class="p">])))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span>
            <span class="n">peak_freq</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">(),</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">set_std_tickparams</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">tsz</span><span class="p">)</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">y_tick_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span> <span class="k">if</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_tick_vals</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">7.2g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">y_tick_vals</span><span class="p">])</span>
        <span class="c1"># ax.ticklabel_format(style=&quot;plain&quot;, axis=&quot;y&quot;, scilimits=(0, 0))</span>
        <span class="c1"># Do the bottom inverse axis</span>
        <span class="n">secax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">secondary_xaxis</span><span class="p">(</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="p">(</span><span class="n">pixper_tofrom_hz</span><span class="p">,</span> <span class="n">pixper_tofrom_hz</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">secax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
            <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span>
            <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">labelsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">secax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">secax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Sinusoid Period (Pixels)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>
        <span class="c1"># Do the top inverse axis</span>
        <span class="n">secax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">secondary_xaxis</span><span class="p">(</span>
            <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="p">(</span><span class="n">pixper_tofrom_hz</span><span class="p">,</span> <span class="n">pixper_tofrom_hz</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">secax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">secax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
            <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span>
            <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">labelsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Add a note about the file creator</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span>
        <span class="mf">0.005</span><span class="p">,</span>
        <span class="mf">0.005</span><span class="p">,</span>
        <span class="s2">&quot;Created by obstools.scrub_deveny_pickup on &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># End</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="k">if</span> <span class="n">qa_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">qa_dir</span>
    <span class="n">extns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">extra_graphics</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;pdf&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">extn</span> <span class="ow">in</span> <span class="n">extns</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_scrubber_fft_analysis.</span><span class="si">{</span><span class="n">extn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="make_sinusoid_fit_plots">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.make_sinusoid_fit_plots">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_sinusoid_fit_plots</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
    <span class="n">fit_coeffs</span><span class="p">:</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">,</span>
    <span class="n">pixel_period</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">qa_dir</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_graphics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fixed_fitc</span><span class="p">:</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">smoothing</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a set of diagnostic plots from the set of sinusoid fits</span>

<span class="sd">    This function creates a multipanel plot saved as ``sinusoid_fits.pdf`` in</span>
<span class="sd">    the current working directory.  The panels are:</span>

<span class="sd">    1. The row-by-row sinusoid amplitude</span>
<span class="sd">    2. The row-by-row sinusoid period</span>
<span class="sd">    3. The row-by-row sinusoid phase shift</span>
<span class="sd">    4. The row-by-row rms residual when the sinusoidal fit is subtracted from</span>
<span class="sd">       the original line</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : :obj:`~pathlib.Path`</span>
<span class="sd">        The filename of the original file, used in the plot title</span>
<span class="sd">    fit_coeffs : :obj:`~astropy.table.Table`</span>
<span class="sd">        The fit coefficients table</span>
<span class="sd">    pixel_period : :obj:`float`</span>
<span class="sd">        The estimated pixel period of the sinusoidal noise from the FFT</span>
<span class="sd">    qa_dir : :obj:`~pathlib.Path`, optional</span>
<span class="sd">        The QA directory into which to place the optional plots.  If ``None``,</span>
<span class="sd">        the plots will be placed in the current working directory.</span>
<span class="sd">        (Default: None)</span>
<span class="sd">    extra_graphics : :obj:`bool`, optional</span>
<span class="sd">        Produce extra graphics formats for documentation?  (Default: False)</span>
<span class="sd">    fixed_fitc : :obj:`~astropy.table.Table`, optional</span>
<span class="sd">        The fit coefficients table with fixed sinusoid  (Default: None)</span>
<span class="sd">    smoothing : :obj:`dict`, optional</span>
<span class="sd">        Polynomial fit coefficients for amplitude and period  (Default: None)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set up the plotting environment</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mf">6.4</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
    <span class="n">tsz</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">xpl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fit_coeffs</span><span class="p">))</span>

    <span class="c1"># Set up iterable lists for making plotting cleaner</span>
    <span class="n">fit_ords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">fit_coeffs</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span>
        <span class="n">fit_coeffs</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">],</span>
        <span class="n">fit_coeffs</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">],</span>
        <span class="n">fit_coeffs</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="n">fix_ords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">fixed_fitc</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span>
        <span class="n">fixed_fitc</span><span class="p">[</span><span class="s2">&quot;lambda&quot;</span><span class="p">],</span>
        <span class="n">fixed_fitc</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">],</span>
        <span class="n">fixed_fitc</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="n">polycoefs</span> <span class="o">=</span> <span class="p">[</span><span class="n">smoothing</span><span class="p">[</span><span class="s2">&quot;p_a&quot;</span><span class="p">],</span> <span class="n">smoothing</span><span class="p">[</span><span class="s2">&quot;p_lambda&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">ylabels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Amplitude (electron)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Period (pixels)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Phase Shift (phase)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RMS of the fit (electron)&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Loop over the axes!</span>
    <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">fit_ord</span><span class="p">,</span> <span class="n">fix_ord</span><span class="p">,</span> <span class="n">polycoef</span><span class="p">,</span> <span class="n">ylabel</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">axes</span><span class="p">,</span> <span class="n">fit_ords</span><span class="p">,</span> <span class="n">fix_ords</span><span class="p">,</span> <span class="n">polycoefs</span><span class="p">,</span> <span class="n">ylabels</span>
    <span class="p">):</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">xpl</span><span class="p">,</span> <span class="n">fit_ord</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Best-Fit per Row&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">xpl</span><span class="p">,</span> <span class="n">fix_ord</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Nearly Constant Sinusoid&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">polycoef</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coef_txt</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">0.98</span><span class="p">,</span>
                <span class="mf">0.95</span><span class="p">,</span>
                <span class="s2">&quot;Chebyshev Coeffs: &quot;</span> <span class="o">+</span> <span class="s2">&quot;   &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">.4g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">polycoef</span><span class="p">]),</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">axis</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">coef_txt</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">({</span><span class="s2">&quot;facecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;0.75&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">})</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>

        <span class="c1"># Add the horizontal line for the FFT-predicted period</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
                <span class="n">pixel_period</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis_transform</span><span class="p">(),</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;FFT-Predicted Period&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Rescale y axis</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]]:</span>
            <span class="n">grow</span> <span class="o">=</span> <span class="mf">1.5</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">med</span><span class="p">,</span> <span class="n">span</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ylim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">med</span> <span class="o">-</span> <span class="n">grow</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">span</span><span class="p">,</span> <span class="n">med</span> <span class="o">+</span> <span class="n">grow</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">span</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Image Row Number&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">set_std_tickparams</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">tsz</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">!=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>

    <span class="c1"># When making plots for the documentation, obfuscate the source</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">extra_graphics</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot; for </span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sinusoid Pattern Fits</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Add a note about the file creator</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span>
        <span class="mf">0.005</span><span class="p">,</span>
        <span class="mf">0.005</span><span class="p">,</span>
        <span class="s2">&quot;Created by obstools.scrub_deveny_pickup on &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="k">if</span> <span class="n">qa_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">qa_dir</span>
    <span class="n">extns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">extra_graphics</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;pdf&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">extn</span> <span class="ow">in</span> <span class="n">extns</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_scrubber_sinusoid_fits.</span><span class="si">{</span><span class="n">extn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="make_image_comparison_plots">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.make_image_comparison_plots">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_image_comparison_plots</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
    <span class="n">spec2d</span><span class="p">:</span> <span class="n">pypeit</span><span class="o">.</span><span class="n">spec2dobj</span><span class="o">.</span><span class="n">Spec2DObj</span><span class="p">,</span>
    <span class="n">resid</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">pattern</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">qa_dir</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">with_obj</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">extra_graphics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a set of Image Comparison plots</span>

<span class="sd">    This function creates a multipanel plot.  The panels are:</span>

<span class="sd">    1. The PypeIt-reduced 2-dimensional spectrum (``spec2d.sciimg``)</span>
<span class="sd">    2. The PypeIt sky spectrum model (``spec2d.skymodel``).</span>
<span class="sd">    3. The PypeIt-reduced residual image (``spec2d.sciimg`` -</span>
<span class="sd">       ``spec2d.skymodel`` - ``spec2d.objmodel``) modified by the good pixel</span>
<span class="sd">       mask</span>
<span class="sd">    4. The noise pattern image generated here from the sinusoidal fits to each</span>
<span class="sd">       row of the residual image</span>
<span class="sd">    5. The cleaned residual image (``resid`` - ``pattern``)</span>
<span class="sd">    6. The cleaned 2-dimensional spectrum (``spec2d.sciimg`` - ``pattern``)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : :obj:`~pathlib.Path`</span>
<span class="sd">        Filename of theraw image from which all this comes</span>
<span class="sd">    spec2d : :class:`~pypeit.spec2dobj.Spec2DObj`</span>
<span class="sd">        The 2D spectral image class from PypeIt</span>
<span class="sd">    resid : :obj:`~numpy.ndarray`</span>
<span class="sd">        The PypeIt-produced residual image (the starting point for the fitting)</span>
<span class="sd">    pattern : :obj:`~numpy.ndarray`</span>
<span class="sd">        The constructed pattern from the sinusoidal fits (mean = 0)</span>
<span class="sd">    qa_dir : :obj:`~pathlib.Path`, optional</span>
<span class="sd">        The QA directory into which to place the optional plots.  If ``None``,</span>
<span class="sd">        the plots will be placed in the current working directory.</span>
<span class="sd">        (Default: None)</span>
<span class="sd">    with_obj: :obj:`bool`, optional</span>
<span class="sd">        Does ``resid`` contain the object model?  (Default: False)</span>
<span class="sd">    extra_graphics : :obj:`bool`, optional</span>
<span class="sd">        Produce extra graphics formats for documentation?  (Default: False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.4</span><span class="p">,</span> <span class="mf">10.67</span><span class="p">))</span>
    <span class="n">tsz</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">interval1</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">ZScaleInterval</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">interval2</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">ZScaleInterval</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Panel #1: Draw the original science image</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">interval1</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">spec2d</span><span class="o">.</span><span class="n">sciimg</span><span class="p">)</span>
    <span class="c1"># print(f&quot;Inferno image limits: {vmin}, {vmax}&quot;)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">spec2d</span><span class="o">.</span><span class="n">sciimg</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Processed Science Image&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>

    <span class="c1"># Panel #2: Draw the sky model</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">spec2d</span><span class="o">.</span><span class="n">skymodel</span> <span class="o">+</span> <span class="n">spec2d</span><span class="o">.</span><span class="n">objmodel</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
        <span class="s2">&quot;Sky Model&quot;</span> <span class="k">if</span> <span class="n">with_obj</span> <span class="k">else</span> <span class="s2">&quot;Sky Model + Object Model&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span>
    <span class="p">)</span>

    <span class="c1"># Panel #6: Draw the cleaned science image</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">spec2d</span><span class="o">.</span><span class="n">sciimg</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">pattern</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Cleaned Science Image (sciimg - pattern)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>

    <span class="c1"># Panel #4: Draw the pattern model</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">interval2</span><span class="o">.</span><span class="n">get_limits</span><span class="p">(</span><span class="n">pattern</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">resid</span><span class="p">))</span>
    <span class="c1"># print(f&quot;Viridis image limits: {vmin}, {vmax}&quot;)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pattern</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">resid</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Modeled Sinusoid Pickup Pattern&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>

    <span class="c1"># Panel #3: Draw the resid image</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">with_obj</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PypeIt Residual Image (sciimg - skymodel)*gpm&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="s2">&quot;PypeIt Residual Noise Image (sciimg - skymodel - objmodel)*gpm&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Panel #5: Draw the cleaned image</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">resid</span> <span class="o">-</span> <span class="n">pattern</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">with_obj</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Residual Image minus Pattern&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Residual Noise Image minus Pattern&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span><span class="p">)</span>

    <span class="c1"># Filename as the &quot;super title&quot;</span>
    <span class="c1"># When making plots for the documentation, obfuscate the source</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">extra_graphics</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot; for </span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image Comparison Plots</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Add a note about the file creator</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span>
        <span class="mf">0.005</span><span class="p">,</span>
        <span class="mf">0.005</span><span class="p">,</span>
        <span class="s2">&quot;Created by obstools.scrub_deveny_pickup on &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">tsz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="k">if</span> <span class="n">qa_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">qa_dir</span>
    <span class="n">extns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">extra_graphics</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;pdf&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">extn</span> <span class="ow">in</span> <span class="n">extns</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_scrubber_image_comparisons.</span><span class="si">{</span><span class="n">extn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<span class="c1"># Utility Functions (Alphabetical) ===========================================#</span>
<div class="viewcode-block" id="make_sine_label">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.make_sine_label">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_sine_label</span><span class="p">(</span><span class="n">popt</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">infodict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">mesg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ier</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a sensible label for the sinusoid example plots</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    popt : :obj:`~numpy.ndarray`</span>
<span class="sd">        The array of fit coefficients from :func:`scipy.optimize.curve_fit`</span>
<span class="sd">    infodict : :obj:`dict`</span>
<span class="sd">        Dictionary containing fit information from :func:`scipy.optimize.curve_fit`</span>
<span class="sd">    mesg : :obj:`str`</span>
<span class="sd">        Message about completion from :func:`scipy.optimize.curve_fit`</span>
<span class="sd">    ier : :obj:`int`</span>
<span class="sd">        Integer describing fir completion from :func:`scipy.optimize.curve_fit`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`str`</span>
<span class="sd">        The legend label thusly constructed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">rf</span><span class="s2">&quot;A = </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2">  $\lambda$ = </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">  $\phi$ = </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2">  &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;$y_0$ = </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">  lin = </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2">  quad = </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2">  &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">ier</span><span class="si">}</span><span class="s2"> | rms = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">infodict</span><span class="p">[</span><span class="s1">&#39;fvec&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">mesg</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="pixper_tofrom_hz">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.pixper_tofrom_hz">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pixper_tofrom_hz</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert to/from pixel period and Hertz</span>

<span class="sd">    _extended_summary_</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    val : :obj:`~numpy.ndarray`</span>
<span class="sd">        Input value(s) to convert</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`~numpy.ndarray`</span>
<span class="sd">        Converted output(s)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">PIX_DWELL</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span></div>



<span class="c1"># Command Line Script Infrastructure (borrowed from PypeIt) ==================#</span>
<div class="viewcode-block" id="ScrubDevenyPickup">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.ScrubDevenyPickup">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ScrubDevenyPickup</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">ScriptBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Script class for ``scrub_deveny_pickup`` tool</span>

<span class="sd">    Script structure borrowed from :class:`pypeit.scripts.scriptbase.ScriptBase`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ScrubDevenyPickup.get_parser">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.ScrubDevenyPickup.get_parser">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_parser</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">formatter</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">HelpFormatter</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the command-line argument parser.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        description : :obj:`str`, optional</span>
<span class="sd">            A short description of the purpose of the script.</span>
<span class="sd">        width : :obj:`int`, optional</span>
<span class="sd">            Restrict the width of the formatted help output to be no longer</span>
<span class="sd">            than this number of characters, if possible given the help</span>
<span class="sd">            formatter.  If None, the width is the same as the terminal</span>
<span class="sd">            width.</span>
<span class="sd">        formatter : :obj:`~argparse.HelpFormatter`</span>
<span class="sd">            Class used to format the help output.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`~argparse.ArgumentParser`</span>
<span class="sd">            Command-line interpreter.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_parser</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Clean RF pickup noise from DeVeny raw frames&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;File(s) to clean&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--proc_dir&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;current working directory&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the directory above that which contains the .pypeit &quot;</span>
            <span class="s2">&quot;file used to process `file` (i.e., the directory above &quot;</span>
            <span class="s2">&quot;ldt_deveny_?) -- use only if `-r` was used in the call to &quot;</span>
            <span class="s2">&quot;`pypeit_setup`.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--overwrite_raw&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Overwrite the raw file rather than create a new file with the &#39;_scrub&#39; suffix&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--diagnostics&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output additional information and plots during the analysis for &quot;</span>
            <span class="s2">&quot;debugging purposes&quot;</span><span class="p">,</span>  <span class="c1"># argparse.SUPPRESS</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--no_refit&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Force no refit of &#39;bad&#39; RMS values&quot;</span><span class="p">,</span>  <span class="c1"># argparse.SUPPRESS</span>
        <span class="p">)</span>
        <span class="c1"># Produce multiple graphics outputs for the documentation -- HIDDEN</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-g&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">)</span>
        <span class="c1"># Feed the pattern image back into the FFT algorithm -- HIDDEN</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>


<div class="viewcode-block" id="ScrubDevenyPickup.main">
<a class="viewcode-back" href="../../api/obstools.scrub_deveny_pickup.html#obstools.scrub_deveny_pickup.ScrubDevenyPickup.main">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main Driver</span>

<span class="sd">        Simple function that takes the input file list and calls the cleaning</span>
<span class="sd">        function for each one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Giddy up!</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">:</span>
            <span class="n">iterative_pypeit_clean</span><span class="p">(</span>
                <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
                <span class="n">proc_dir</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">proc_dir</span><span class="p">),</span>
                <span class="n">overwrite_raw</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">overwrite_raw</span><span class="p">,</span>
                <span class="n">diagnostics</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">,</span>
                <span class="n">no_refit</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">no_refit</span><span class="p">,</span>
                <span class="n">extra_graphics</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">g</span><span class="p">,</span>
                <span class="n">rerun_fft</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">f</span><span class="p">,</span>
            <span class="p">)</span></div>
</div>


            <span class="c1"># Deprecated original method</span>
            <span class="c1"># clean_pickup(</span>
            <span class="c1">#     pathlib.Path(file),</span>
            <span class="c1">#     use_hann=use_hann,</span>
            <span class="c1">#     sine_plot=not no_plots,</span>
            <span class="c1">#     fft_plot=not no_plots,</span>
            <span class="c1"># )</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023-2025, Lowell Observatory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>